/*
 * twoWayScroll - Infinite loading data or images on web pages by two-way scroll
 *
 * @copyright Jerry Chen
 * 
 * @license MIT License
 * 
 * @author Jerry Chen (https://github.com/ordinary9843/twoWayScroll)
 * 
 * @version 1.0.0
 * 
 * @requires jQuery v1.9.1+
 */
!function(v){"use strict";function o(c,t){let e=c.data("twoWayScroll"),l="function"==typeof t?{callback:t}:t,d=v.extend({},v.twoWayScroll.defaults,l,e||{}),f="visible"===c.css("overflow-y"),o=c.find(d.prevSelector).first(),r=c.find(d.nextSelector).first(),s=v(window),i=v("body"),p=f?s:c,n=v.trim(o.prop("href")+" "+d.contentSelector),a=v.trim(r.prop("href")+" "+d.contentSelector),S=function(){c.find(".twoWayScroll-inner").length||c.contents().wrapAll('<div class="twoWayScroll-inner" />')},g=function(t){let e;d.pagingSelector?t.closest(d.pagingSelector).hide():(e=t.parent().not(".twoWayScroll-inner, .twoWayScroll-added").addClass("twoWayScroll-parent").hide(),e.length||t.wrap('<div class="twoWayScroll-parent" />').parent().hide())},h=function(){return p.unbind(".twoWayScroll").removeData("twoWayScroll").find(".twoWayScroll-inner").children().unwrap().filter(".twoWayScroll-added").children().unwrap()},w=function(){if(c.is(":visible")){S();let t=c.find("div.twoWayScroll-inner").first(),e=c.data("twoWayScroll");var r,i=parseInt(c.css("borderTopWidth"),10),n=isNaN(i)?0:i,a=parseInt(c.css("paddingTop"),10)+n,i=f?p.scrollTop():c.offset().top,n=t.length?t.offset().top:0,a=Math.ceil(i-n+p.height()+a);let l="undefined",o="undefined";return!e.prevHref||(r=e.prevHref.split(" "))[0]&&(l=r[0]),!e.nextHref||(r=e.nextHref.split(" "))[0]&&(o=r[0]),!e.prevWaiting&&"undefined"!==l&&a+d.padding<s.height()/d.prevLoadHeight?(!0===d.replaceState&&history.replaceState(null,document.title,l),W()):!e.nextWaiting&&"undefined"!==o&&a+d.padding>=t.outerHeight()?(!0===d.replaceState&&history.replaceState(null,document.title,o),y()):void 0}},u=function(){let t=c.find(d.prevSelector).first(),e=c.find(d.nextSelector).first();var l;t.length&&(d.autoTrigger?(g(t),l=i.height()-c.offset().top,l=c.height()<l?c.height():l,(0<c.offset().top-s.scrollTop()?s.height()-(c.offset().top-v(window).scrollTop()):s.height())<l&&w(),p.unbind(".twoWayScroll").bind("scroll.twoWayScroll",w)):(p.unbind(".twoWayScroll"),t.bind("click.twoWayScroll",function(){g(t),W()}))),e.length&&(d.autoTrigger?(g(e),l=i.height()-c.offset().top,(c.height()<l?c.height():l)<=(0<c.offset().top-s.scrollTop()?s.height()-(c.offset().top-v(window).scrollTop()):s.height())&&w(),p.unbind(".twoWayScroll").bind("scroll.twoWayScroll",w)):(p.unbind(".twoWayScroll"),e.bind("click.twoWayScroll",function(){g(e),y()})))},W=function(){let t=c.find("div.twoWayScroll-inner").first(),i=c.data("twoWayScroll");return i.prevWaiting=!0,t.prepend('<div class="twoWayScroll-added" />').children(".twoWayScroll-added").first().html('<div class="twoWayScroll-loading" id="twoWayScroll-loading">'+d.loadingHtml+"</div>").promise().done(function(){d.loading&&d.loading()}),c.animate({scrollTop:t.outerHeight()},0,function(){let r=i.prevHref;t.find("div.twoWayScroll-added").first().load(r,function(t,e){if("error"===e)return h();let l=v(this).find(d.prevSelector).first();var o;i.prevWaiting=!1,i.prevHref=!!l.prop("href")&&v.trim(l.prop("href")+" "+d.contentSelector),v(".twoWayScroll-parent",c).remove(),s.scrollTop(v(window).height()),(o=o||c.data("twoWayScroll"))&&o.prevHref&&u(),d.callback&&(o=(e=r.split(" "))[0],e=e[1],d.callback.call(this,o,e))})})},y=function(){let t=c.find("div.twoWayScroll-inner").first(),i=c.data("twoWayScroll");return i.nextWaiting=!0,t.append('<div class="twoWayScroll-added" />').children(".twoWayScroll-added").last().html('<div class="twoWayScroll-loading" id="twoWayScroll-loading">'+d.loadingHtml+"</div>").promise().done(function(){d.loading&&d.loading()}),c.animate({scrollTop:t.outerHeight()},0,function(){let r=i.nextHref;t.find("div.twoWayScroll-added").last().load(r,function(t,e){if("error"===e)return h();let l=v(this).find(d.nextSelector).first();var o;i.nextWaiting=!1,i.nextHref=!!l.prop("href")&&v.trim(l.prop("href")+" "+d.contentSelector),v(".twoWayScroll-parent",c).remove(),(o=o||c.data("twoWayScroll"))&&o.nextHref&&u(),d.callback&&(o=(e=r.split(" "))[0],e=e[1],d.callback.call(this,o,e))})})};return c.data("twoWayScroll",v.extend({},e,{initialized:!0,prevWaiting:!1,nextWaiting:!1,prevHref:n,nextHref:a})),S(),function(){var e=v(d.loadingHtml).filter("img").attr("src");if(e){let t=new Image;t.src=e}}(),u(),v.extend(c.twoWayScroll,{destroy:h}),c}v.twoWayScroll={defaults:{autoTrigger:!0,replaceState:!0,padding:0,prevLoadHeight:1.5,prevSelector:"a:first",nextSelector:"a:last",contentSelector:"",pagingSelector:"",loadingHtml:"<span>Loading</span>",loading:!1,callback:!1}},v.fn.twoWayScroll=function(l){return this.each(function(){let t=v(this);var e=t.data("twoWayScroll");e&&e.initialized||o(t,l)})}}(jQuery);